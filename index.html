
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>APUSH Study Chatbot ‚Äî up through Articles era</title>
<style>
:root{--bg:#f6f9fc;--card:#fff;--accent:#1769aa;--muted:#566574;--ok:#c8f7c5;--bad:#f7c5c5}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; padding:24px; color:#0b2540}
.wrap{max-width:1100px;margin:0 auto}
header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
h1{font-size:20px;margin:0}
.subtitle{color:var(--muted);font-size:13px}
.main{display:grid;grid-template-columns:360px 1fr;gap:16px}
.panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(8,30,50,.06)}
.modes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
button,.pill{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
button.secondary{background:#e6eef6;color:#0b2540}
button:disabled{opacity:.55;cursor:not-allowed}
.chat{height:62vh;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg,#eef7ff,transparent)}
.msg{margin:8px 0;max-width:78%}
.bot{background:#fff;padding:10px;border-radius:10px}
.user{align-self:flex-end;background:#dbeeff;padding:10px;border-radius:10px;margin-left:auto}
.small{font-size:12px;color:var(--muted)}
select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #d6e6f6}
footer{margin-top:12px;display:flex;gap:8px}
.controls{display:flex;gap:8px;align-items:center}
.mcq button{display:block;width:100%;text-align:left;margin:6px 0;padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;color:#0b2540;font-size:14px}
.tag{background:#eef5fb;border-radius:6px;padding:6px 8px;font-size:12px;color:var(--accent);display:inline-block}
kbd{background:#eef; padding:2px 6px; border-radius:6px; font-size:12px}
.dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.28);padding:20px}
.dialog .card{max-width:720px;background:#fff;border-radius:12px;padding:18px}
.editor{font-family:monospace;font-size:12px;height:100px;overflow:auto;padding:8px;border-radius:8px;border:1px dashed #d7e9fb;background:#fcfeff}
hr.sep{border:0;border-top:1px solid #e6eef6;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>APUSH Study Chatbot ‚Äî up through the Articles of Confederation</h1>
      <div class="subtitle">Friendly, concise feedback ‚Äî flashcards, AP-style MCQs, short answers, and conversational Q&A grounded in your AMSCO text.</div>
    </div>
    <div style="margin-left:auto;text-align:right">
      <div class="tag">Exploration ‚Üí Colonial Society ‚Üí Revolution Causes ‚Üí Articles</div>
      <div class="small">For review; not a replacement for assigned reading.</div>
    </div>
  </header>

  <div class="main">
    <div class="panel">
      <div class="small">Mode</div>
      <div class="modes">
        <button id="mode-flash">Flashcards</button>
        <button id="mode-mcq">AP-style MCQ</button>
        <button id="mode-short">Short Answer</button>
        <button id="mode-ask">Ask the Bot</button>
        <button id="helpBtn" class="secondary">Help</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Choose Topic</div>
        <select id="topicSelect" style="width:100%;margin-top:6px"></select>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="nextBtn">Next</button>
        <button id="showAnsBtn">Show Answer</button>
        <button id="hintBtn" class="secondary">Hint</button>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Study data (read-only preview)</div>
        <div id="studyPreview" class="editor"></div>
        <div class="small" style="margin-top:6px">Ask Mode uses conversational summaries built from your pasted AMSCO text (this unit range only).</div>
      </div>

      <div class="small" style="margin-top:10px;line-height:1.4">
        Tips: <kbd>Next</kbd> shows the next card/question. <kbd>Show Answer</kbd> reveals flashcard answers. In MCQs, feedback appears immediately. <kbd>Hint</kbd> gives a nudge.
      </div>
    </div>

    <div class="panel">
      <div class="chat" id="chatArea" aria-live="polite"></div>
      <footer>
        <div style="flex:1">
          <input id="userInput" type="text" placeholder="Type a question (Ask mode) or a short answer. Otherwise use Next ‚Üí" style="width:100%"/>
        </div>
        <div class="controls">
          <button id="sendBtn">Send</button>
        </div>
      </footer>
    </div>
  </div>
</div>

<!-- Help dialog -->
<div id="helpDlg" class="dialog" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="card">
    <h3 id="helpTitle" style="margin:0 0 8px">How to use this page</h3>
    <ol style="margin:0 0 10px 18px;line-height:1.5">
      <li><b>Flashcards</b>: <kbd>Next</kbd> shows a term, <kbd>Hint</kbd> gives a nudge, <kbd>Show Answer</kbd> reveals details.</li>
      <li><b>AP-style MCQ</b>: <kbd>Next</kbd>, click A‚ÄìE ‚Üí instant feedback + brief explanation. <kbd>Hint</kbd> if you want a clue first.</li>
      <li><b>Short Answer</b>: <kbd>Next</kbd> for a prompt; reply in 2‚Äì4 sentences. I‚Äôll nudge with key points.</li>
      <li><b>Ask the Bot</b>: Type any question (e.g., ‚ÄúWhy did Britain pass the Stamp Act?‚Äù). I‚Äôll answer based on this unit‚Äôs AMSCO content.</li>
      <li>Use the <b>Topic</b> menu to focus. You can always switch modes mid-topic.</li>
    </ol>
    <div class="small">Grounded in your uploaded AMSCO content for this unit only.</div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="helpClose" class="secondary">Close</button>
    </div>
  </div>
</div>

<script>
/* ============================
   STUDY DATA (Flashcards + MCQs)
   NOTE: Kept concise here to fit; you can expand later.
   ============================ */

const studyData = {
  topics: [
/* ---------- 1. Exploration & Colonization ---------- */
{
 id:"explore",
 title:"Exploration & Colonization",
 summary:"Columbian Exchange, Spanish systems, early English settlements, Puritans.",
 flashcards:[
  {q:"Columbian Exchange",a:"Two-way transfer after 1492 that reshaped diets, disease patterns, and societies across the Atlantic."},
  {q:"Christopher Columbus",a:"1492 voyage opened lasting contact between Europe and the Americas; launched an era of colonization and exchange."},
  {q:"Encomienda System",a:"Spanish grants giving settlers control of native labor/tribute; often abusive; later supplemented by African slavery (asiento)."},
  {q:"Spanish Conquest",a:"Cort√©s conquered the Aztecs; Pizarro the Incas; bullion shipments made Spain Europe‚Äôs richest power in the 1500s."},
  {q:"Bartolom√© de Las Casas",a:"Spanish priest who criticized abuses; New Laws (1542) tried to curb encomienda; only partly successful."},
  {q:"English Policy w/ Natives",a:"Fewer large empires to exploit; more family settlement; rising land pressure led to conflict and Native displacement."},
  {q:"Jamestown (1607)",a:"Early disease/starvation; John Smith‚Äôs discipline and tobacco (Rolfe) sustained it; became a royal colony."},
  {q:"Plymouth & Mayflower Compact",a:"Separatists (Pilgrims) formed a 'civil body politic' for self-rule; modest growth on fish/furs/lumber."},
  {q:"Massachusetts Bay & Puritans",a:"1630 Winthrop‚Äôs 'city upon a hill'; Great Migration; congregational churches and town meetings."},
  {q:"Salutary Neglect",a:"Loose enforcement of imperial rules; colonial self-government grew until Britain tightened control after 1763."}
 ],
 mcqs:[
  {q:"Which best captures the Columbian Exchange‚Äôs impact?",choices:[
    "It isolated the Atlantic worlds","It was limited to metals","It transformed diets, populations, and ecosystems on both sides","It eliminated epidemic disease","It created immediate equality"],answer:2,expl:"New foods boosted populations; Old World diseases devastated Native communities."},
  {q:"Spanish vs. English colonization differed mainly in that",choices:[
    "Both were settler-only","Spanish emphasized extraction/mission; English built settler colonies/local assemblies","English used encomienda","Spanish used joint-stock firms","English banned local government"],answer:1,expl:"Spain prioritized conquest and conversion; English ventures leaned settler/self-rule."},
  {q:"The Mayflower Compact is significant because it",choices:[
    "Created a national constitution","Established consent-based self-government among settlers","Guaranteed universal suffrage","Banned taxes","Abolished slavery"],answer:1,expl:"Compact bound settlers to laws for the common good."}
 ]
},

/* ---------- 2. Colonial Society & Regions ---------- */
{
 id:"society",
 title:"Colonial Society & Regions",
 summary:"Regional economies; labor systems; religion; demographic change.",
 flashcards:[
  {q:"Southern vs. Middle vs. New England",a:"South: plantation staples/slavery; Middle: grains/diverse faiths; New England: towns/mixed economy/longer life."},
  {q:"Indentured Servitude & Headright",a:"Contracts exchanged passage for labor; headrights gave land to sponsors; reliance declined as slavery expanded."},
  {q:"Bacon‚Äôs Rebellion (1676)",a:"Frontier grievances + elite control ‚Üí rebellion; hastened shift toward racialized chattel slavery."},
  {q:"Salem Witch Trials (1692)",a:"Mass hysteria; led to skepticism of spectral evidence and some legal reforms."},
  {q:"Navigation Acts",a:"Mercantilist trade rules channeling commerce through England on English ships; often evaded."},
  {q:"Dominion of New England",a:"James II‚Äôs consolidation to tighten control; Andros limited town meetings; ended after Glorious Revolution."},
  {q:"Triangular Trade",a:"Rum‚ÜíAfrica, enslaved people‚ÜíWest Indies, sugar‚ÜíNew England; profits fueled expansion."},
  {q:"Religious Toleration",a:"Varied by colony; RI & PA relatively liberal; established churches faded over time."},
  {q:"Enlightenment (Locke)",a:"Natural rights and consent influenced colonial thought and later revolutionary ideology."}
 ],
 mcqs:[
  {q:"Bacon‚Äôs Rebellion contributed to",choices:[
    "Renewed reliance on indentured servants","Greater reliance on enslaved Africans","Decline of plantations","New England town meetings","Immediate colonial independence"],answer:1,expl:"Planters viewed enslaved labor as more controllable than indentures."},
  {q:"Navigation Acts were intended to",choices:[
    "Promote free trade","Channel colonial trade through England","Raise colonial wages","Abolish smuggling","Fund French wars"],answer:1,expl:"They enforced mercantilist goals favoring England."}
 ]
},

/* ---------- 3. Imperial Tensions ‚Üí Revolution ---------- */
{
 id:"imperial",
 title:"Imperial Tensions ‚Üí Revolution",
 summary:"French & Indian War, British acts, colonial resistance to 1776.",
 flashcards:[
  {q:"French & Indian War (1754‚Äì63)",a:"Costly British victory; debts and new policies led to tighter control and taxation."},
  {q:"Pontiac‚Äôs Rebellion (1763)",a:"Native coalition attacked forts/settlements; led to British troops suppressing and the Proclamation of 1763."},
  {q:"Proclamation of 1763",a:"Banned settlement west of Appalachians; aimed to limit conflict; angered land-hungry colonists."},
  {q:"Sugar Act (1764)",a:"Lowered molasses duty but tightened enforcement; signaled revenue focus; admiralty courts."},
  {q:"Quartering Act (1765)",a:"Required housing/supplies for British troops; raised fears over local autonomy."},
  {q:"Stamp Act (1765)",a:"Direct tax on printed items; sparked boycotts, Sons/Daughters of Liberty, Stamp Act Congress."},
  {q:"Declaratory Act (1766)",a:"Repealed Stamp Act but asserted Parliament‚Äôs power 'in all cases whatsoever.'"},
  {q:"Townshend Acts (1767)",a:"Duties on imports; revenue to pay royal officials; writs of assistance; boycotts followed."},
  {q:"Boston Massacre (1770)",a:"Confrontation with troops killed five; used as propaganda to galvanize resistance."},
  {q:"Committees of Correspondence",a:"Networking to share news/strategy; built intercolonial unity."},
  {q:"Gaspee (1772)",a:"Colonists burned customs schooner; threat of trials heightened tensions."},
  {q:"Tea Act (1773)",a:"Cheaper BEIC tea seen as trap to accept taxation; resistance continued."},
  {q:"Boston Tea Party (1773)",a:"342 chests dumped in protest; escalated conflict."},
  {q:"Intolerable (Coercive) Acts (1774)",a:"Punished Massachusetts (port closed, gov‚Äôt altered, quartering expanded) + Quebec Act."},
  {q:"First Continental Congress (1774)",a:"Suffolk Resolves; Declaration and Resolves; The Association (non-import/export/consume)."},
  {q:"Lexington & Concord (1775)",a:"Opening clashes; 'shot heard ‚Äôround the world.'"},
  {q:"Second Continental Congress (1775)",a:"Chose Washington; organized war; Olive Branch Petition rejected."},
  {q:"Common Sense (1776)",a:"Paine argued plainly for independence and republicanism."}
 ],
 mcqs:[
  {q:"Proclamation of 1763 aimed to",choices:[
    "Encourage western settlement","Stop salutary neglect","Limit settlement to ease Native conflict","Create a colonial parliament","Raise revenue on tea"],answer:2,expl:"It tried to stabilize the frontier after war and Pontiac‚Äôs Rebellion."},
  {q:"Stamp Act mattered because it",choices:[
    "Was an indirect customs duty","Taxed only merchants","Was a direct internal tax on common items and spurred coordinated boycotts","Granted home rule","Created a colonial army"],answer:2,expl:"It hit everyday transactions and united colonies in protest."},
  {q:"Townshend duties were controversial partly because they",choices:[
    "Paid royal officials from local funds","Paid royal officials with duty revenue, reducing colonial leverage","Ended writs of assistance","Lowered tea prices","Banned vice-admiralty courts"],answer:1,expl:"Salaries from duties insulated officials from local assemblies."},
  {q:"Intolerable Acts primarily",choices:[
    "Rewarded Boston","Punished Massachusetts and asserted imperial control","Ended quartering","Granted Quebec independence","Funded colonial schools"],answer:1,expl:"They closed the port and altered MA governance."}
 ]
},

/* ---------- 4. Articles Era (early war context included) ---------- */
{
 id:"articles",
 title:"Articles Era & Social Change",
 summary:"Early war context + Articles of Confederation accomplishments/weaknesses.",
 flashcards:[
  {q:"Bunker Hill (1775)",a:"Costly British assault; Americans inflicted heavy casualties‚Äîmoral boost despite retreat."},
  {q:"Olive Branch Petition (1775)",a:"Last appeal to the king for reconciliation; rejected as the Prohibitory Act declared colonies in rebellion."},
  {q:"Patriots, Loyalists, Neutrals",a:"Support split; significant Loyalist presence in NY, NJ, GA; many tried to remain neutral."},
  {q:"Articles of Confederation (1781)",a:"One-house Congress; no taxing or enforcement power; required 9/13 to pass key laws; unanimous to amend."},
  {q:"Northwest Ordinance (1787)",a:"Territory‚Üístatehood path; limited self-gov‚Äôt; banned slavery in NW Territory; promoted education."},
  {q:"Shays‚Äô Rebellion (1786‚Äì87)",a:"Debtor-tax revolt in MA; exposed national weakness under Articles; spurred calls for stronger gov‚Äôt."},
  {q:"Social Changes",a:"Reduced aristocratic privileges; church-state separation grew; women kept economy running; slavery questioned but persisted, especially in South."}
 ],
 mcqs:[
  {q:"A core weakness of the Articles was",choices:[
    "Too-strong executive","No power to tax or enforce laws","Judicial supremacy","Export taxes on states","National draft"],answer:1,expl:"Congress lacked revenue and enforcement power."},
  {q:"Northwest Ordinance significance:",choices:[
    "Expanded slavery","Created admission rules and banned slavery in NW Territory","Created federal courts","Ended tariffs","Gave land to existing states"],answer:1,expl:"Model for orderly growth + slavery restriction there."}
 ]
}
]
};

/* ============================
   Short-answer prompts (rotated)
   ============================ */
const shortPrompts = [
 "In 2‚Äì4 sentences, explain how the French & Indian War set the stage for colonial resistance to British policies.",
 "In 2‚Äì4 sentences, why did the Articles of Confederation prove inadequate? Name two specific weaknesses.",
 "In 2‚Äì4 sentences, compare Spanish and British motives and methods of colonization.",
 "In 2‚Äì4 sentences, explain why 'Common Sense' shifted public opinion.",
 "In 2‚Äì4 sentences, identify two causes and two effects of the Intolerable Acts."
];

/* ============================
   Conversational AMSCO summaries (from your pasted text)
   ‚Äì Friendly 2‚Äì4 sentence blurbs used by Ask Mode.
   ‚Äì Keys are flexible; fuzzy search will match.
   ============================ */
const amscoSummaries = {
 "columbian exchange":"Great question! The Columbian Exchange was the massive swap of plants, animals, and diseases after 1492. Europe gained foods like corn and potatoes, while the Americas got wheat, sugar, horses‚Äîand devastating diseases. It permanently reshaped diets, populations, and power across the Atlantic world.",
 "christopher columbus":"Columbus, backed by Spain in 1492, sailed west looking for Asia but landed in the Americas. Even though he misidentified the lands and peoples, his voyages opened permanent contact between Europe and the New World. That contact launched colonization, conquest, and a global transformation.",
 "spanish conquest":"Spain‚Äôs early dominance came from bold expeditions and conquests‚ÄîCort√©s over the Aztecs and Pizarro over the Incas‚Äîsending shiploads of gold and silver home. Wealth and power surged, encouraging more colonization. These empires also set up systems to control labor and extract resources.",
 "encomienda":"Under encomienda, Spanish settlers received land and the right to Indigenous labor and tribute. In practice, it often meant harsh exploitation, despite claims of 'protection' and conversion. As disease and abuse reduced native populations, Spain increasingly imported enslaved Africans.",
 "asiento":"The asiento was Spain‚Äôs licensed system to import enslaved Africans to the Americas for a royal tax. It grew as Native populations declined. It tied Atlantic economies together in a tragic, profit-driven traffic in human beings.",
 "bartolome de las casas":"Las Casas started as a colonist but became a fierce critic of Native mistreatment. He pushed reforms like the New Laws (1542) to curb slavery and forced labor. Resistance by colonists blunted changes, but his voice shaped debates about empire and morality.",
 "english policy toward natives":"Early on, some English colonies traded and cooperated with Native groups, but pressures for land quickly drove conflict. Unlike Spanish rule over large empires, English settlers often displaced smaller tribes. The result was recurring warfare and Native migration inland.",
 "native reaction":"Native peoples responded in different ways‚Äîalliances, trade, warfare, and migration‚Äîto survive disease, violence, and colonization. Because tribes acted separately, European powers often avoided a unified resistance. Indigenous strategies adapted continually to new realities.",
 "jamestown":"Jamestown nearly failed from disease, starvation, and poor organization. John Smith‚Äôs strict rules and John Rolfe‚Äôs tobacco crop helped it survive. Eventually, the crown took over, making Virginia England‚Äôs first royal colony.",
 "mayflower compact":"The Mayflower Compact was a simple but important agreement among Plymouth settlers to form a government and obey its rules. It‚Äôs an early example of self-government by consent. That tradition grows stronger in New England town meetings.",
 "plymouth":"Plymouth struggled through its first winter, then stabilized with Native help and a mixed economy based on fish, furs, and lumber. It stayed small compared to Massachusetts Bay. Its legacy is strong on community and covenant.",
 "massachusetts bay puritans":"Puritans hoped to purify the Church of England and build a godly 'city upon a hill.' They created congregational churches and local town meetings. Religious zeal brought community cohesion‚Äîbut also intolerance for dissent.",
 "great migration":"Political turmoil in England sent thousands of Puritans to Massachusetts in the 1630s. The influx boosted towns, churches, and local governance. It helped make New England unusually stable and family-centered.",
 "roger williams":"Williams championed freedom of conscience and fair dealings with Native peoples. Banished from Massachusetts, he founded Providence (Rhode Island) with remarkable religious toleration. It became a refuge for dissenters of many kinds.",
 "anne hutchinson":"Hutchinson argued that faith alone‚Äînot works‚Äîwas necessary for salvation, challenging Puritan leaders. Banished from Massachusetts, she helped found Portsmouth (later part of Rhode Island). Her story highlights conflicts over authority and religious freedom.",
 "fundamental orders of connecticut":"These were among the first written constitutions in America (1639). They set up a representative government with elected legislators and governor. It‚Äôs a building block in the tradition of self-rule.",
 "king philip‚Äôs war":"Metacom (King Philip) led a Native alliance against expanding English settlements (1675‚Äì76). The war was brutal and costly on both sides; colonists ultimately prevailed, breaking major Native resistance in New England. It marked a turning point in regional power.",
 "new york (duke of york)":"England seized New Amsterdam from the Dutch and renamed it New York. The crown tried to rule without an assembly, but colonists pushed back‚Äîearly evidence that English settlers expected representation. Eventually, civil rights and an assembly were restored.",
 "new jersey":"New Jersey began as two proprietary colonies with generous land grants and religious toleration, then merged into a royal colony. Conflicting land claims and frequent ownership changes created confusion. Unification helped stabilize governance.",
 "quakers and william penn":"Quakers believed in equality, inner light, and pacifism‚Äîradical ideas for the time. William Penn founded Pennsylvania as a 'holy experiment' with elected assemblies, religious liberty, and fair treatment of Natives. It attracted diverse settlers and grew quickly.",
 "south carolina rice economy":"South Carolina shifted from provisioning the West Indies to rice and indigo plantations worked by enslaved Africans. Its economy and culture resembled the Caribbean more than New England. Slavery became central.",
 "georgia oglethorpe":"Georgia started as a philanthropic buffer colony against Spanish Florida, banning rum and slavery early on. It struggled under the rules and constant security pressure. Over time, restrictions eased and the colony aligned with southern patterns.",
 "mercantilism":"Mercantilism said colonies existed to enrich the mother country through controlled trade. England‚Äôs Navigation Acts steered commerce on English ships and through English ports. Colonists benefited in some ways but resented limits and costs.",
 "navigation acts":"These laws required English/colonial ships and routed goods through England; certain 'enumerated' goods could go only to England. New England shipbuilding thrived, but manufacturing was constrained and smuggling spread. Tensions simmered under lax enforcement.",
 "dominion of new england":"James II combined several colonies under Governor Andros, limiting town meetings and altering land titles to tighten royal control. The Glorious Revolution toppled him and ended the Dominion. Colonies regained separate charters, but imperial ambitions remained.",
 "triangular trade":"New England rum to Africa, enslaved people to the West Indies (Middle Passage), sugar back to New England. Each leg aimed at profit. It tied the Atlantic economies together, with immense human cost.",
 "population growth and diversity":"By 1775, the colonial population soared to ~2.5 million, fueled by immigration and high birthrates. Germans, Scots-Irish, and others added diversity, especially in the Middle Colonies and backcountry. Africans‚Äîfree and enslaved‚Äîmade up about 20%.",
 "self-government":"Most colonies had elected assemblies that approved taxes. Governors were often appointed by crown or proprietor, but local legislatures held the purse strings. This nurtured habits of representation and debate.",
 "religion and established churches":"Protestant groups dominated but varied by region. Over time, states reduced tax support for established churches, with RI and PA especially tolerant. Disestablishment grew after independence.",
 "enlightenment locke":"Enlightenment thinkers emphasized reason, natural rights, and consent of the governed. Locke argued people could change governments that violated rights. These ideas influenced revolutionary leaders and the founding.",
 "regional economies":"New England: mixed economy with small farms, shipping, lumber, and rum. Middle Colonies: grains, ironwork, and growing towns. South: plantations (tobacco, rice, indigo) with enslaved labor; many small farmers too.",
 "local government models":"New England centered on town meetings and direct voting. The South used counties with sheriffs and appointed officials. These patterns shaped local political culture.",
 "voting and limits":"Participation expanded for white male property holders, but many were still excluded‚Äîwomen, most free Blacks, enslaved people, and the poor. Even with limits, colonial politics leaned more participatory than Europe.",
 "french and indian war overview":"Britain and France fought for control of North America; early British setbacks gave way to victories under Pitt. The 1763 Peace of Paris handed Britain French Canada and Spanish Florida. War debts and new responsibilities pushed Britain to tax and regulate the colonies.",
 "albany plan of union":"Franklin proposed a joint colonial council for defense and taxation in 1754. Colonies rejected it to keep local control. Still, it foreshadowed later intercolonial cooperation.",
 "british vs colonial views after 1763":"Britain doubted colonial military reliability and resented poor support. Colonists felt proud and capable‚Äîand unimpressed with British tactics in American terrain. The 'victory' exposed expectations on both sides.",
 "pontiac‚Äôs rebellion":"A Native alliance attacked forts and settlements after 1763, angered by land grabs and changed diplomacy. Britain sent regular troops to suppress it. The crisis helped prompt the Proclamation Line.",
 "proclamation of 1763":"Britain barred settlement west of the Appalachians to reduce frontier conflict. Colonists‚Äîeager for land‚Äîresented the limit and often ignored it. It became an early flashpoint over imperial authority.",
 "sugar act":"The Sugar Act lowered the molasses duty but cracked down on smuggling with stricter enforcement and admiralty courts. Colonists noticed the revenue motive. It signaled a new approach after salutary neglect.",
 "quartering act":"Colonies were required to house and supply British troops. Many saw it as intrusive and a burden. It fueled suspicions about standing armies in peacetime.",
 "stamp act":"This 1765 direct tax on printed materials hit everyday life‚Äînewspapers, legal papers, cards. Protests, boycotts, the Sons/Daughters of Liberty, and the Stamp Act Congress built intercolonial unity. Pressure worked‚ÄîParliament repealed it in 1766.",
 "declaratory act":"Parliament repealed the Stamp Act but asserted full authority to legislate for the colonies 'in all cases whatsoever.' It planted the seed for the next conflicts.",
 "townshend acts":"Duties on glass, lead, paint, paper, and tea‚Äîwith revenues paying royal officials‚Äîreduced colonial leverage. Writs of assistance allowed broad searches. Boycotts returned; smuggling persisted.",
 "massachusetts circular letter":"Otis and Samuel Adams urged colonies to petition repeal of Townshend duties. Britain threatened the legislature and sent more troops to Boston. Resistance spread through intercolonial communication.",
 "boston massacre":"Tension in Boston boiled over in 1770; soldiers fired into a crowd, killing five. John Adams defended them at trial; Samuel Adams used the event as propaganda. It rallied Patriot sentiment.",
 "committees of correspondence":"Local and intercolonial committees shared news and coordinated responses. They kept the cause alive during quiet periods. This network was crucial for unity.",
 "gaspee incident":"Rhode Islanders burned a hated customs ship; Britain threatened to try suspects in England. It heightened fears of lost jury trials and arbitrary power.",
 "tea act":"Parliament made BEIC tea cheaper‚Äîeven with the tax‚Äîto undercut smuggling. Colonists saw it as a trick to accept Parliament‚Äôs right to tax. Resistance held firm.",
 "boston tea party":"Disguised colonists dumped tea into Boston Harbor in 1773. Some cheered; others worried it went too far. Britain responded with hardline measures.",
 "intolerable acts":"The Coercive Acts punished Massachusetts‚Äîclosing the port, reshaping the government, expanding quartering‚Äîand the Quebec Act extended Quebec to the Ohio and recognized Catholicism. Colonists saw a threat to rights and western claims.",
 "first continental congress":"Delegates endorsed the Suffolk Resolves, declared colonial rights, and formed The Association to enforce boycotts. Most weren‚Äôt seeking independence yet‚Äîjust restoration of rights.",
 "lexington and concord":"British troops marched to seize supplies; militia met them at Lexington and then harassed them back from Concord. 'The shot heard ‚Äôround the world' started the war.",
 "bunker hill":"Americans fortified Breed‚Äôs Hill; the British took it at high cost. Colonists proved they could stand up to regulars. It boosted Patriot morale.",
 "second continental congress":"Congress organized the war, chose Washington, and sent the Olive Branch Petition. The king rejected it and cut off trade‚Äîthe break widened.",
 "olive branch petition and prohibitory act":"Colonists appealed for reconciliation; the king refused and labeled them in rebellion. Trade was banned‚Äîpushing moderates toward independence.",
 "common sense":"Thomas Paine argued clearly for independence and a republic‚Äîno more monarchy. It reached ordinary readers and shifted public opinion.",
 "patriots and loyalists":"Support split; many Patriots came from New England and Virginia, while Loyalists were strong in NY/NJ/GA. Many people tried to stay out of it altogether.",
 "articles of confederation":"The first U.S. framework created a weak central government with a one-house Congress‚Äîno tax power and limited enforcement. Cooperation was hard; amending required unanimity.",
 "northwest ordinance":"Congress set rules for territories to become states and banned slavery in the Northwest Territory. It supported education and civil liberties. It was a major success under the Articles.",
 "shays‚Äô rebellion":"Debt-ridden farmers in Massachusetts rose up over taxes and foreclosures. The uprising exposed the Articles‚Äô weakness in crises. It helped spur calls to strengthen the government.",
 "social change after revolution":"Titles and primogeniture faded; church-state separation advanced; women kept farms and shops running during the war. Slavery was questioned, restricted in the North‚Äîbut expanded and defended in much of the South."
};

/* ============================
   UI Elements & Logic
   ============================ */
const chat = document.getElementById('chatArea');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const topicSelect = document.getElementById('topicSelect');
const modeFlash = document.getElementById('mode-flash');
const modeMcq = document.getElementById('mode-mcq');
const modeShort = document.getElementById('mode-short');
const modeAsk = document.getElementById('mode-ask');
const nextBtn = document.getElementById('nextBtn');
const showAnsBtn = document.getElementById('showAnsBtn');
const resetBtn = document.getElementById('resetBtn');
const studyPreview = document.getElementById('studyPreview');
const helpBtn = document.getElementById('helpBtn');
const helpDlg = document.getElementById('helpDlg');
const helpClose = document.getElementById('helpClose');
const hintBtn = document.getElementById('hintBtn');

let mode = 'flash';
let currentTopicId = studyData.topics[0].id;
let index = 0;
let lastMCQ = null;
let lastFlash = null;
let lastShort = null;

function appendMsg(html, who='bot'){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='bot'?'bot':'user');
  div.innerHTML = html;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function escapeHtml(s){ return s.replace(/[&<>]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }
function tokens(s){ return (s||'').toLowerCase().match(/[a-z0-9']+/g)||[]; }

function loadTopics(){
  topicSelect.innerHTML = '';
  studyData.topics.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.id; opt.textContent = t.title;
    topicSelect.appendChild(opt);
  });
  topicSelect.value = currentTopicId;
}
function setPreview(){
  const meta = studyData.topics.map(t=>({topic:t.title, flashcards:t.flashcards.length, mcqs:t.mcqs.length}));
  const askSize = Object.keys(amscoSummaries).length;
  studyPreview.textContent = JSON.stringify({topics:meta, amscoSummaries:askSize},null,2);
}
function updateHintState(){ hintBtn.disabled = !(lastFlash || lastMCQ); }
function clearCurrent(){ lastFlash = null; lastMCQ = null; lastShort = null; updateHintState(); }

/* -----------------------------
   Flashcards (with hints)
   ----------------------------- */
function showFlash(topic){
  if(!topic.flashcards.length){ appendMsg("No flashcards in this topic.",'bot'); clearCurrent(); return; }
  lastFlash = topic.flashcards[index % topic.flashcards.length];
  lastMCQ = null; lastShort = null; updateHintState();
  appendMsg("<b>Flashcard</b><br>Term: "+escapeHtml(lastFlash.q)+"<br><em>Click Hint for a nudge, or Show Answer.</em>", 'bot');
  index++;
}
function showFlashAnswer(){ if(lastFlash) appendMsg("<b>Answer:</b> "+lastFlash.a,'bot'); updateHintState(); }
function flashHint(){ if(lastFlash){ const clue = lastFlash.a.split(/[.]/)[0]+"‚Ä¶"; appendMsg("üí° Hint: "+clue,'bot'); } }

/* -----------------------------
   MCQs ‚Äî immediate feedback + hints
   ----------------------------- */
function showMCQ(topic){
  if(!topic.mcqs.length){ appendMsg("No MCQs in this topic.",'bot'); clearCurrent(); return; }
  const q = topic.mcqs[index % topic.mcqs.length]; 
  lastMCQ = q; lastFlash=null; lastShort=null; updateHintState(); index++;

  let html = "<b>AP-style MCQ</b><div style='margin-top:6px'><em>"+escapeHtml(q.q)+"</em></div>";
  q.choices.forEach((c,i)=>{
    html += `<div class="mcq"><button data-i="${i}" class="mcq-btn">${String.fromCharCode(65+i)}. ${escapeHtml(c)}</button></div>`;
  });
  html += `<div class="mcq-feedback" style="margin-top:8px;color:var(--muted)"><em>Choose an option above.</em></div>`;
  appendMsg(html,'bot');

  setTimeout(()=>{
    const container = chat.querySelector(".mcq-feedback:last-of-type");
    const buttons = chat.querySelectorAll("button.mcq-btn");
    buttons.forEach(b=>{
      if(b._bound) return; b._bound=true;
      b.onclick = ()=>{
        const choice = +b.getAttribute('data-i'); 
        handleMCQAnswer(choice,q,b,buttons,container);
      };
    });
  },30);
}
function handleMCQAnswer(chosen,q,btn,allBtns,feedbackDiv){
  const correct = q.answer;
  allBtns.forEach((b,i)=>{
    b.disabled = true;
    b.style.background = "#fff"; // reset
    if(i===correct) b.style.background = "var(--ok)";
    if(i===chosen && i!==correct) b.style.background = "var(--bad)";
  });
  if(chosen===correct){
    feedbackDiv.innerHTML = "‚úÖ <b>Correct.</b> "+escapeHtml(q.choices[correct])+" ‚Äî "+escapeHtml(q.expl);
  } else {
    feedbackDiv.innerHTML = "‚ùå <b>Not quite.</b> Correct answer: <b>"+
      String.fromCharCode(65+correct)+". "+escapeHtml(q.choices[correct])+
      "</b><br><em>"+escapeHtml(q.expl)+"</em>";
  }
  updateHintState();
}
function mcqHint(){ if(lastMCQ){ const clue = lastMCQ.expl.split(/[.]/)[0]+"‚Ä¶"; appendMsg("üí° Hint: "+clue,'bot'); } }

/* -----------------------------
   Short Answer
   ----------------------------- */
function showShort(){
  lastShort = shortPrompts[index % shortPrompts.length]; lastFlash=null; lastMCQ=null; updateHintState(); index++;
  appendMsg("<b>Short Answer Prompt</b><div style='margin-top:6px'>"+escapeHtml(lastShort)+"</div>",'bot');
}
function gradeShortAnswer(text){
  const lower = text.toLowerCase();
  let hits = 0;
  if(lower.match(/tax|revenue|debt/)) hits++;
  if(lower.match(/articles|weak central/)) hits++;
  if(lower.match(/shays/)) hits++;
  if(lower.match(/natural rights|consent/)) hits++;
  const msg = hits>=2
   ? "Nice job ‚Äî you included key ideas. For full credit, anchor with an example (e.g., Shays‚Äô Rebellion, Articles lacking tax power)."
   : "You're on the right track, but add concrete causes/effects (e.g., war debts ‚Üí taxes; Articles‚Äô weakness ‚Üí unrest).";
  appendMsg(msg,'bot');
}

/* -----------------------------
   Conversational Ask Mode
   ‚Äì fuzzy search across amscoSummaries + flashcards + MCQ stems
   ----------------------------- */
function scoreText(qTokens, text){
  const tks = tokens(text);
  let score = 0;
  qTokens.forEach(q=>{
    const c = tks.filter(t=>t===q).length;
    if(c) score += c*2;
    // light partials
    if(!c) { if(tks.some(t=>t.startsWith(q)) ) score += 1; }
  });
  return score;
}
function searchKnowledge(query){
  const qTokens = tokens(query).filter(x=>x.length>2);
  let best = {key:null,text:null,score:0,src:"amsco"};

  // AMSCO summaries
  Object.entries(amscoSummaries).forEach(([k,v])=>{
    const s = scoreText(qTokens, k+" "+v);
    if(s>best.score) best = {key:k,text:v,score:s,src:"amsco"};
  });

  // Flashcards
  studyData.topics.forEach(t=>{
    t.flashcards.forEach(fc=>{
      const s = scoreText(qTokens, fc.q+" "+fc.a);
      if(s>best.score) best = {key:fc.q,text:fc.a,score:s,src:"flash",topic:t.id};
    });
  });

  // MCQ stems/explanations
  studyData.topics.forEach(t=>{
    t.mcqs.forEach(m=>{
      const s = scoreText(qTokens, m.q+" "+(m.expl||"")+" "+m.choices.join(" "));
      if(s>best.score) best = {key:m.q,text:(m.expl||""),score:s,src:"mcq",topic:t.id,mcq:m};
    });
  });

  return best;
}

function handleAsk(text){
  const q = text.trim();
  if(!q){ appendMsg("Try asking about a term (e.g., 'Stamp Act') or a cause/effect link.",'bot'); return; }
  const hit = searchKnowledge(q);
  if(!hit || hit.score===0){
    appendMsg("I didn‚Äôt find a strong match in this unit. Try a specific name, law, or event (e.g., 'Proclamation of 1763').",'bot'); 
    return;
  }
  // Compose a friendly 2‚Äì4 sentence reply using source
  if(hit.src==="amsco"){
    appendMsg(hit.text + "<br><span class='small'>Source: this unit‚Äôs AMSCO summary.</span>",'bot');
  } else if(hit.src==="flash"){
    appendMsg("Here‚Äôs the quick idea: "+hit.text+"<br><span class='small'>Source: flashcard for <b>"+escapeHtml(hit.key)+"</b>.</span>",'bot');
  } else if(hit.src==="mcq"){
    const add = hit.text ? " Here‚Äôs why it matters: "+hit.text : "";
    appendMsg("In short: "+escapeHtml(hit.key)+"."+add+"<br><span class='small'>Source: practice question on this topic.</span>",'bot');
    appendMsg("Want to try an MCQ on this topic?",'bot');
  }
}

/* -----------------------------
   Mode + Controls
   ----------------------------- */
modeFlash.onclick = ()=>{ mode='flash'; index=0; clearCurrent(); appendMsg("Flashcards ready. Press <b>Next</b> for a term.",'bot'); }
modeMcq.onclick   = ()=>{ mode='mcq';   index=0; clearCurrent(); appendMsg("MCQs loaded. Press <b>Next</b> to start. Click <b>Hint</b> for a clue first if you like.",'bot'); }
modeShort.onclick = ()=>{ mode='short'; index=0; clearCurrent(); appendMsg("Short answers: I‚Äôll prompt; you reply in 2‚Äì4 sentences.",'bot'); }
modeAsk.onclick   = ()=>{ mode='ask';              appendMsg("Ask mode: type any question from this unit. I‚Äôll answer from the AMSCO-based summaries.",'bot'); }

topicSelect.onchange = ()=>{ currentTopicId = topicSelect.value; index=0; clearCurrent(); appendMsg("Topic set to: <b>"+ studyData.topics.find(t=>t.id===currentTopicId).title+"</b>",'bot'); }

nextBtn.onclick = ()=>{
  const topic = studyData.topics.find(t=>t.id===currentTopicId);
  if(!topic){ appendMsg("Pick a topic first.",'bot'); return; }
  if(mode==='flash') showFlash(topic);
  else if(mode==='mcq') showMCQ(topic);
  else if(mode==='short') showShort();
  else appendMsg("In Ask mode, type a question below and press <b>Send</b>.",'bot');
}
showAnsBtn.onclick = ()=>{ if(mode==='flash') showFlashAnswer(); else appendMsg("For MCQs, feedback appears as soon as you click an option. Use <b>Hint</b> for a nudge first.",'bot'); }
hintBtn.onclick = ()=>{ if(mode==='flash') flashHint(); else if(mode==='mcq') mcqHint(); else appendMsg("Hints are available in Flashcards or MCQ mode.",'bot'); }
resetBtn.onclick = ()=>{ index=0; clearCurrent(); appendMsg("Reset complete. Choose a mode and press <b>Next</b>.",'bot'); }

sendBtn.onclick = handleUser;
userInput.addEventListener('keydown',e=>{ if(e.key==='Enter') handleUser(); });
function handleUser(){
  const text = userInput.value.trim(); if(!text) return;
  appendMsg(escapeHtml(text),'user'); userInput.value='';
  if(mode==='ask')   return handleAsk(text);
  if(mode==='short') return gradeShortAnswer(text);
  appendMsg("Tip: use <b>Next</b> for the next item, or switch to Ask/Short Answer.",'bot');
}

/* Help dialog */
helpBtn.onclick = ()=> helpDlg.style.display='flex';
helpClose.onclick = ()=> helpDlg.style.display='none';
helpDlg.addEventListener('click',e=>{ if(e.target===helpDlg) helpDlg.style.display='none'; });

/* Init */
(function init(){
  loadTopics();
  setPreview();
  updateHintState();
  appendMsg("Hi! I‚Äôm your APUSH study buddy. Choose a topic and mode, then press <b>Next</b>. Ask me anything from this unit in <b>Ask the Bot</b>.",'bot');
  mode='flash';
})();
</script>
</body>
</html>
